#!/bin/sh
# Custom DevOps / IT services overview for MOTD (3 columns, emojis & colors)
#
# Services configurables via la variable d'environnement MOTD_SERVICES :
#   MOTD_SERVICES="name:label:icon name2:label2:icon2 ..."
#
# Exemple :
#   MOTD_SERVICES="ssh:ssh:üîê fail2ban:fail2ban:üõ°Ô∏è ufw:ufw:üöß docker:docker:üê≥ nginx:nginx:üåê apache2:apache2:üì¶"

# 0) Charger les variables MOTD_* depuis /etc/environment
if [ -r /etc/environment ]; then
  set -a
  . /etc/environment
  set +a
fi

if ! command -v systemctl >/dev/null 2>&1; then
  exit 0
fi

COUNTER=0

service_status() {
  NAME="$1"
  LABEL="$2"
  ICON="$3"

  if systemctl list-unit-files "${NAME}.service" >/dev/null 2>&1 || \
     systemctl status "$NAME" >/dev/null 2>&1; then

    STATUS=$(systemctl is-active "$NAME" 2>/dev/null)
    [ -z "$STATUS" ] && STATUS="unknown"

    case "$STATUS" in
      active)
        STATUS_COLOR="\033[1;32m$STATUS\033[0m"    # vert
        ;;
      inactive|failed)
        STATUS_COLOR="\033[1;31m$STATUS\033[0m"    # rouge
        ;;
      *)
        STATUS_COLOR="\033[1;33m$STATUS\033[0m"    # jaune / autre
        ;;
    esac
  else
    STATUS="absent"
    STATUS_COLOR="\033[1;90m$STATUS\033[0m"        # gris
  fi

  PADDED_LABEL=$(printf '%-10s' "$LABEL")
  BOLD_LABEL="\033[1m${PADDED_LABEL}\033[0m"

  printf "  %s %b: %b" "$ICON" "$BOLD_LABEL" "$STATUS_COLOR"

  COUNTER=$((COUNTER + 1))
  if [ $((COUNTER % 3)) -eq 0 ]; then
    printf "\n"
  else
    printf "    "
  fi
}

echo
echo "services:"

if [ -n "${MOTD_SERVICES:-}" ]; then
  OLDIFS=$IFS
  IFS=' '
  for entry in $MOTD_SERVICES; do
    [ -z "$entry" ] && continue
    IFS=':'; set -- $entry
    NAME="$1"
    LABEL="$2"
    ICON="$3"
    [ -z "$NAME" ] && continue
    [ -z "$LABEL" ] && LABEL="$NAME"
    [ -z "$ICON" ] && ICON="‚Ä¢"
    service_status "$NAME" "$LABEL" "$ICON"
  done
  IFS=$OLDIFS
else
  # Fallback par d√©faut
  service_status ssh       "ssh"       "üîê"
  service_status fail2ban  "fail2ban"  "üõ°Ô∏è"
  service_status ufw       "ufw"       "üöß"
  service_status docker    "docker"    "üê≥"
  service_status nginx     "nginx"     "üåê"
  service_status apache2   "apache2"   "üì¶"
fi

if [ "$COUNTER" -ne 0 ] && [ $((COUNTER % 3)) -ne 0 ]; then
  printf "\n"
fi
