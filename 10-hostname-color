#!/bin/sh
# Hostname banner: derives display name, strips optional prefix/suffix, supports override.
# Env: `MOTD_HOST_PREFIX_STRIP`, `MOTD_HOST_SUFFIX_STRIP`, `MOTD_HOST_OVERRIDE`.
# Renders with `figlet` (and `lolcat` if available) or a simple fallback.

# Load MOTD_* from `/etc/environment` when PAM does not pass them.
if [ -r /etc/environment ]; then
  set -a
  . /etc/environment
  set +a
fi

RAW_HOSTNAME=$(hostname -s)
APP_NAME="$RAW_HOSTNAME"

# Strip prefix if configured.
if [ -n "${MOTD_HOST_PREFIX_STRIP:-}" ]; then
  PREFIX="$MOTD_HOST_PREFIX_STRIP"
  case "$APP_NAME" in
    "$PREFIX"*)
      APP_NAME=${APP_NAME#"$PREFIX"}
      ;;
  esac
fi

# Strip suffix if configured.
if [ -n "${MOTD_HOST_SUFFIX_STRIP:-}" ]; then
  SUFFIX="$MOTD_HOST_SUFFIX_STRIP"
  case "$APP_NAME" in
    *"$SUFFIX")
      APP_NAME=${APP_NAME%"$SUFFIX"}
      ;;
  esac
fi

# Optional final override.
if [ -n "${MOTD_HOST_OVERRIDE:-}" ]; then
  APP_NAME="$MOTD_HOST_OVERRIDE"
fi

# Sanitize: remove CR/LF from name.
APP_NAME=$(printf '%s' "$APP_NAME" | tr -d '\r\n')

# Detect `figlet` and `lolcat` (Ubuntu sometimes at `/usr/games`).
FIGLET_BIN=$(command -v figlet 2>/dev/null || echo "")
LOLCAT_BIN=""

if [ -x /usr/games/lolcat ]; then
  LOLCAT_BIN="/usr/games/lolcat"
else
  LOLCAT_BIN=$(command -v lolcat 2>/dev/null || echo "")
fi

if [ -n "$FIGLET_BIN" ]; then
  if [ -n "$LOLCAT_BIN" ]; then
    # Wide width to avoid awkward wrapping.
    "$FIGLET_BIN" -w 200 "$APP_NAME" | "$LOLCAT_BIN" -f
  else
    "$FIGLET_BIN" -w 200 "$APP_NAME"
  fi
else
  printf '*** %s ***\n' "$APP_NAME"
fi
