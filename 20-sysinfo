#!/bin/sh
# System info summary: distro/kernel, uptime, CPU/memory, IP, optional zone, updates.
# Zone config via env:
# - `MOTD_ZONE_DMZ_REGEX`: grep -E regex on IP to classify as DMZ
# - `MOTD_ZONE_LAN_REGEX`: grep -E regex on IP to classify as LAN
# - `MOTD_ZONE_OTHER_LABEL`: label for other zone (default shown only if set)
# If none set, omit the "Zone:" label and show only IP.

# Load MOTD_* env from `/etc/environment`.
if [ -r /etc/environment ]; then
  set -a
  . /etc/environment
  set +a
fi

GREEN="\033[1;32m"
BLUE="\033[1;34m"
RED="\033[1;31m"
YELLOW="\033[1;33m"
RESET="\033[0m"

LGREEN="\033[1;92m"
LBLUE="\033[1;94m"
LMAGENTA="\033[1;95m"
LRED="\033[1;91m"

# Distro & kernel.
if command -v lsb_release >/dev/null 2>&1; then
  DISTRO=$(lsb_release -ds)
else
  DISTRO="$(uname -s) $(uname -r)"
fi
KERNEL=$(uname -r)

# Uptime (pretty format).
if uptime -p >/dev/null 2>&1; then
  UPTIME_RAW=$(uptime -p 2>/dev/null | sed 's/^up //')
else
  UPTIME_RAW=$(uptime | sed 's/.*up \([^,]*\), .*/\1/')
fi

# Highlight numbers in uptime as green.
COLORED_UPTIME=""
for token in $UPTIME_RAW; do
  if printf '%s\n' "$token" | grep -Eq '^[0-9]+$'; then
    COLORED_UPTIME="$COLORED_UPTIME ${GREEN}${token}${RESET}"
  else
    COLORED_UPTIME="$COLORED_UPTIME $token"
  fi
done
COLORED_UPTIME=${COLORED_UPTIME# }

# CPU model & vCPUs.
CPU_MODEL=$(lscpu 2>/dev/null | awk -F: '/Model name/ {sub(/^ +/, "", $2); print $2; exit}')
if [ -z "$CPU_MODEL" ]; then
  CPU_MODEL=$(grep -m1 'model name' /proc/cpuinfo 2>/dev/null | cut -d: -f2- | sed 's/^ *//')
fi
VCPUS=$(nproc 2>/dev/null || echo "?")

# Memory (used / available / total).
MEM_LINE=$(free -h | awk '/^Mem:/ {print $3" "$7" "$2}')
MEM_USED=$(printf '%s\n' "$MEM_LINE" | awk '{print $1}')
MEM_AVAIL=$(printf '%s\n' "$MEM_LINE" | awk '{print $2}')
MEM_TOTAL=$(printf '%s\n' "$MEM_LINE" | awk '{print $3}')

# Primary IPv4 and optional zone classification.
IP=$(hostname -I 2>/dev/null | awk '{print $1}')
ZONE=""
ZONE_LABEL=""
OTHER_LABEL="${MOTD_ZONE_OTHER_LABEL:-OTHER}"

# Check if any zone config is defined.
ZONE_CFG=0
[ -n "${MOTD_ZONE_DMZ_REGEX:-}" ] && ZONE_CFG=1
[ -n "${MOTD_ZONE_LAN_REGEX:-}" ] && ZONE_CFG=1
[ -n "${MOTD_ZONE_OTHER_LABEL:-}" ] && ZONE_CFG=1

if [ -n "$IP" ] && [ "$ZONE_CFG" -eq 1 ]; then
  if [ -n "${MOTD_ZONE_DMZ_REGEX:-}" ] && printf '%s\n' "$IP" | grep -Eq "$MOTD_ZONE_DMZ_REGEX"; then
    ZONE="DMZ"
  elif [ -n "${MOTD_ZONE_LAN_REGEX:-}" ] && printf '%s\n' "$IP" | grep -Eq "$MOTD_ZONE_LAN_REGEX"; then
    ZONE="LAN"
  else
    if [ -n "${MOTD_ZONE_OTHER_LABEL:-}" ]; then
      ZONE="$OTHER_LABEL"
    else
      ZONE=""
    fi
  fi
fi

# Colorize zone label.
case "$ZONE" in
  DMZ)  ZONE_LABEL="${RED}DMZ${RESET}" ;;
  LAN)  ZONE_LABEL="${BLUE}LAN${RESET}" ;;
  "")   ZONE_LABEL="" ;;
  *)    ZONE_LABEL="${YELLOW}${ZONE}${RESET}" ;;
esac

echo
echo "system info:"
printf "  Distro......: %b%s%b\n" "$GREEN" "$DISTRO" "$RESET"
printf "  Kernel......: %bLinux %s%b\n" "$GREEN" "$KERNEL" "$RESET"

if [ -n "$COLORED_UPTIME" ]; then
  printf "  Uptime......: %b\n" "$COLORED_UPTIME"
fi

echo
printf "  CPU.........: %s (%b%s%b vCPU)\n" "$CPU_MODEL" "$GREEN" "$VCPUS" "$RESET"
printf "  Memory......: %b%s%b used, %b%s%b avail, %b%s%b total\n" \
  "$GREEN" "$MEM_USED" "$RESET" \
  "$GREEN" "$MEM_AVAIL" "$RESET" \
  "$GREEN" "$MEM_TOTAL" "$RESET"

if [ -n "$IP" ] && [ -n "$ZONE_LABEL" ]; then
  printf "  Network.....: %s | Zone: %b\n" "$IP" "$ZONE_LABEL"
elif [ -n "$IP" ]; then
  printf "  Network.....: %s\n" "$IP"
fi

# Integrated updates summary (apt-based distros only).
if command -v apt >/dev/null 2>&1; then
  echo

  UPDATES_LIST=$(apt list --upgradable 2>/dev/null | sed '1{/^Listing/d}')

  if [ -n "$UPDATES_LIST" ]; then
    TOTAL=$(printf '%s\n' "$UPDATES_LIST" | wc -l | tr -d ' ')
    SECURITY=$(printf '%s\n' "$UPDATES_LIST" | grep -i 'security' | wc -l | tr -d ' ')
  else
    TOTAL=0
    SECURITY=0
  fi

  OTHER_UPD=$((TOTAL - SECURITY))

  TOTAL_COLOR="${LGREEN}${TOTAL}${RESET}"
  SECURITY_COLOR="${LBLUE}${SECURITY}${RESET}"
  OTHER_COLOR="${LMAGENTA}${OTHER_UPD}${RESET}"

  printf "  Updates.....: %b (üõ°Ô∏è %b security | üì¶ %b others)\n" \
    "$TOTAL_COLOR" "$SECURITY_COLOR" "$OTHER_COLOR"

  if [ -f /run/reboot-required ] || [ -f /var/run/reboot-required ]; then
    STATUS_TEXT="${LRED}required!${RESET}"
  else
    STATUS_TEXT="${LGREEN}not required!${RESET}"
  fi

  printf "  Reboot......: %b\n" "$STATUS_TEXT"
fi
